---
title: "Final_Submission_AC"
author: "Angelique Cortez"
date: "2024-08-25"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
set.seed(1001001)
```
```{r}
library(ggplot2)
library(dplyr)
library(ggpubr)
library(kableExtra)
library(tidyr)
```

```{r}
#read the downloaded csvs for the gene expression and metadata
gene_expression <- read.csv("~/Dropbox (Dartmouth College)/Dartmouth Classes/Summer2024/Intro to data analysis/data/QBS103_GSE157103_genes.csv")
metadata <- read.csv("~/Dropbox (Dartmouth College)/Dartmouth Classes/Summer2024/Intro to data analysis/data/QBS103_GSE157103_series_matrix.csv", header = T)
```

#Use function to create histogram and 
```{r}
# Write a function that can recreate the plots from submission one and two but fix the unknown variable
generate_plots <- function(data, genes, continuous_covariate, categorical_covariate1, categorical_covariate2) {
  
  for (gene in genes) {
    # Preprocess the data for the gene of interest
    gene_data <- data %>%
      filter(gene == !!gene) %>%
      mutate(
        # Extract age using a regular expression and convert to numeric
        !!continuous_covariate := as.numeric(sub(".*_(\\d{2})y_.*", "\\1", participant_id)),
        # Extract sex, identifying male or female
        !!categorical_covariate1 := sub(".*_(male|female)_.*", "\\1", participant_id)
      ) %>%
      # Filter out participants labeled as "unknown"
      filter(!grepl("unknown", participant_id)) %>%
      select(expression, !!sym(continuous_covariate), !!sym(categorical_covariate1), !!sym(categorical_covariate2)) %>%
      distinct()  # Ensure no duplicate rows
    
    # Check if the gene_data has the correct number of data points
    print(paste("Number of data points for gene", gene, ":", nrow(gene_data)))
    
    # Histogram: distribution of expression values
    histogram_plot <- ggplot(gene_data, aes(x = expression)) +
      geom_histogram(binwidth = 10, fill = "blue", color = "black", alpha = 0.7) +
      labs(title = paste("Histogram of", gene, "Gene Expression"),
           x = "Expression Level",
           y = "Frequency") +
      theme_minimal()
    
    print(histogram_plot)
    
    # Scatterplot: expression vs continuous covariate, colored by categorical covariate1
    # Calculate the Pearson correlation coefficient and p-value
correlation_test <- cor.test(gene_data[[continuous_covariate]], gene_data$expression, method = "pearson")
correlation_value <- round(correlation_test$estimate, 2)
p_value <- round(correlation_test$p.value, 4)

# Create the scatter plot
scatter_plot <- ggplot(gene_data, aes_string(x = continuous_covariate, y = "expression", color = categorical_covariate1)) +
  geom_point(size = 3, alpha = 0.7) +
  geom_smooth(method = "lm", se = FALSE, color = "black", linetype = "dashed") +  # Add the correlation line
  annotate("text", x = 5, y = max(gene_data$expression) * 0.9, 
           label = paste("R =", correlation_value, "\np =", p_value), 
           color = "black", size = 5, hjust = 0) +  # Display the correlation coefficient and p-value
  scale_x_continuous(breaks = seq(0, 100, by = 10)) +  # Customize x-axis breaks if needed
  labs(title = paste("Scatterplot of", gene, "Expression vs", continuous_covariate),
       x = "Age (yrs)",  # Update x-axis title here
       y = "Expression Level",
       color = categorical_covariate1) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10),
    legend.position = "right"
  )

    
    print(scatter_plot)
    
    # Boxplot: expression by categorical_covariate1, separated by categorical_covariate2
    box_plot <- ggplot(gene_data, aes_string(x = categorical_covariate1, y = "expression", fill = categorical_covariate2)) +
      geom_boxplot() +
      labs(title = paste("Boxplot of", gene, "Expression by", categorical_covariate1, "and", categorical_covariate2),
           x = categorical_covariate1,
           y = "Expression Level",
           fill = categorical_covariate2) +
      theme_minimal() +
      facet_wrap(as.formula(paste("~", categorical_covariate2))) +
      theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
    
    print(box_plot)
  }
}


```



```{r}
generate_plots(
  data = combined_data, 
  genes = c("ABI1"), 
  continuous_covariate = "age", 
  categorical_covariate1 = "sex", 
  categorical_covariate2 = "mechanical_ventilation"
)
```





```{r}
# Remove the row with participant_id 'NONCOVID_15_83y_unknown_ICU'
filtered_data <- combined_data %>%
  filter(participant_id != "NONCOVID_15_83y_unknown_ICU")

# Check the result
print(filtered_data)
```

#Used inspiration to make summry table from https://stackoverflow.com/questions/59214500/summary-table-of-numeric-and-categorical-data-in-r
```{r}
# Load necessary packages
library(dplyr)
library(tidyr)
library(kableExtra)

# Replace 'var1' and 'var2' with your actual continuous variables
#continuous_vars <- c("expression", "age","ferritin.ng.ml.", "crp.mg.l.")



calcs <- filtered_data %>%
  mutate(
    sex = forcats::fct_relevel(sex, "male"),  # Adjusted to match the actual levels
    icu_status = forcats::fct_relevel(icu_status, "yes", "no")
  ) %>%
  group_by(icu_status, sex) %>%
  summarise(
     n = n(),# number of participants per row
    mean_age = round(mean(age, na.rm = TRUE), digits = 2),
    sd_age = round(sd(age, na.rm = TRUE), digits = 2),
    mean_ferritin = round(mean(ferritin.ng.ml., na.rm = TRUE), digits = 2),
    sd_ferritin = round(sd(ferritin.ng.ml., na.rm = TRUE), digits = 2),
    mean_crp = round(mean(crp.mg.l., na.rm = TRUE), digits = 2),
    sd_crp = round(sd(crp.mg.l., na.rm = TRUE), digits = 2),
    .groups = "drop"
  ) %>%
  ungroup() %>%
  tidyr::replace_na(list(sd_age = 0, sd_ferritin = 0, sd_crp = 0))

calcs

# Format the table for LaTeX output using kableExtra
latex_table <- calcs %>%
  kbl(format = "latex", booktabs = TRUE, caption = "Summary Statistics of Covariates") %>%
  kable_styling(latex_options = "hold_position")
# Print the table (this can be copy-pasted into your LaTeX document)
latex_table

```



